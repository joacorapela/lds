\documentclass[12pt]{article}

\usepackage{natbib}
\usepackage{apalike}
\usepackage[hypertexnames=false,colorlinks=true,breaklinks]{hyperref}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage[margin=2.0cm]{geometry}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{siunitx}
\sisetup{output-exponent-marker=\ensuremath{\mathrm{e}}}
\usepackage{tikz}
\usepackage{subcaption}
% \usepackage{endfloat}

\usetikzlibrary{bayesnet}

\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{Theorem}

\title{Inference in Linear Dynamical Systems}
\author{Joaquin Rapela\thanks{j.rapela@ucl.ac.uk}}

\begin{document}

\maketitle

\section{Linear dynamical systems (LDS) model}
\label{sec:ldsModel}

\begin{alignat*}{2}
    \mathbf{x}_{n+1}&=A_n\mathbf{x}_n+\mathbf{w}_n&\quad&\text{with }\mathbf{w}_n\sim N(0,Q_n)\\
    \mathbf{y}_n&=B_n\mathbf{x}_n+\mathbf{v}_n&&\text{with }\mathbf{v}_n\sim N(0,R_n)\\
    \mathbf{x}_0&\sim N(\mathbf{m}_0,V_0)&&
\end{alignat*}

\begin{figure}[h]
\begin{center}
    \input{figLDS}
    \label{fig:ldsGraphicalModel}
    \caption{Graphical models for the linear dynamical system}
\end{center}
\end{figure}

\section{Inference Problems}
\label{sec:inferenceProblems}

\begin{description}
    \item[Prediction]
        \begin{align}
            P(\mathbf{x}_n|\mathbf{y}_1,\ldots,\mathbf{y}_{n-1})=N(\mathbf{x}_n|\mathbf{x}_{n|n-1},P_{n|n-1})\label{eq:prediction}
        \end{align}
    \item[Filtering]
        \begin{align}
            P(\mathbf{x}_n|\mathbf{y}_1,\ldots,\mathbf{y}_{n})=N(\mathbf{x}_n|\mathbf{x}_{n|n},P_{n|n})\label{eq:filtering}
        \end{align}
    \item[Smoothing]
        \begin{align}
            P(\mathbf{x}_n|\mathbf{y}_1,\ldots,\mathbf{y}_{N})=N(\mathbf{x}_n|\mathbf{x}_{n|N},P_{n|N})\label{eq:smoothing}
        \end{align}
    \item[Forecasting]
        \begin{align}
            P(\mathbf{x}_{n+h}|\mathbf{y}_1,\ldots,\mathbf{y}_{n})=N(\mathbf{x}_n|\mathbf{x}_{n+h|n},P_{n+h|n})\label{eq:forecasting}
        \end{align}
\end{description}

\section{Kalman Filter}

The Kalman filter algorithm addresses the prediction (Eq.~\ref{eq:prediction})
and filtering (Eq.~\ref{eq:filtering}) inference problems.
%
It is an iterative algorithm, which alternates between computing the mean and
covariance of the prediction distribution and computing the mean and covariance
of the filtering distribution.

Inference of predicted and filtered means and covariances proceeds in a forward
fashion, inferring the prediction and filtering distributions from the first to
the last state, as shown in the next figure.

\begin{figure}[h]
\begin{center}
    \includegraphics[width=5in]{figures/kfAlternations.pdf}
    \caption{Order of calculation of the prediction and filtering distributions
    in the Kalman filtering algorithm.}
    \label{fig:kfAlternations.}
\end{center}
\end{figure}

\section{Derivation of Kalman filter equations}

\input{derivationKalmanFilterEqs}

\section{Joint normality of the states and observations in the LDS}

\begin{lemma}
    The state and observation random variables of an LDS $\{\mathbf{x}_0,
    \mathbf{x}_1, \ldots, \mathbf{x}_N, \mathbf{y}_1, \ldots, \mathbf{y}_N\}$
    are jointly normal.
\end{lemma}

\begin{proof}

    Note that a set of real random variables $\mathcal{Z}=\{z_1,\ldots,z_N\}$ is
    jointly normal if and only if their joint probability distribution is a
    multivariate Normal distribution, if and only if the logarithm of this
    joint probability distribution is a quadratic function of the random
    variables in $\mathcal{Z}$ (i.e., $\ln P(z_1,\ldots,z_N)=k+\sum_{i=1}^N
    k_1(i)z_i+\sum_{i=1}^N\sum_{j=1}^Nk_2(i,j)z_iz_j$, with $k_1(i)$ and
    $k_2(i,j)$ real numbers).

    Thus, to prove this lemma it suffice to show that property $P_n$:\ ``$\log
    P(\mathbf{x}_0, \mathbf{x}_1, \ldots, \mathbf{x}_n, \mathbf{y}_1, \ldots,
    \mathbf{y}_n)$  is a quadratic function of the components of
    $\{\mathbf{x}_0, \mathbf{x}_1, \ldots, \mathbf{x}_n, \mathbf{y}_1, \ldots,
    \mathbf{y}_n\}$'' holds for any positive integer n. We show this by
    induction.

    \begin{description}
        \item[$P_1$]:
            \begin{align}
                \ln P(\mathbf{x}_0, \mathbf{x}_1, \mathbf{y}_1)=&\ln P(\mathbf{y}_1|\mathbf{x}_1)\ln P(\mathbf{x}_1|\mathbf{x}_0)\ln P(\mathbf{x}_0)\nonumber\\
                                                               =&K-\frac{1}{2}(\mathbf{y}_1-C\mathbf{x}_1)^\intercal R^{-1}(\mathbf{y}_1-C\mathbf{x}_1)\nonumber\\
                                                                &-\frac{1}{2}(\mathbf{x}_1-A\mathbf{x}_0)^\intercal Q^{-1}(\mathbf{x}_1-A\mathbf{x}_0)\nonumber\\
                                                                &-\frac{1}{2}(\mathbf{x}_0-\mathbf{m}_0)^\intercal Q^{-1}(\mathbf{x}_0-\mathbf{m}_0)\label{eq:p1}
            \end{align}

            $P_1$ follows from the observation that the components of
            $\mathbf{x}_0$, $\mathbf{x}_1$ and $\mathbf{y_1}$ are combined
            quadratically in Eq.~\ref{eq:p1}.

        \item[$P_n\rightarrow P_{n+1}$]:
            \begin{align}
                \ln P(\mathbf{x}_0, \mathbf{x}_1, \ldots, \mathbf{x}_n, \mathbf{x}_{n+1},\mathbf{y}_1, \ldots, \mathbf{y}_{n}, \mathbf{y}_{n+1})=&\ln P(\mathbf{y}_{n+1}|\mathbf{x}_{n+1})+\nonumber\\
                &\ln P(\mathbf{x}_{n+1}|\mathbf{x}_n)+\nonumber\\
                &\ln P(\mathbf{x}_0,\mathbf{x}_1,\ldots,\mathbf{x}_n,\mathbf{y}_1, \ldots, \mathbf{y}_{n})\nonumber\\
                =&K-\frac{1}{2}(\mathbf{y}_{n+1}-C\mathbf{x}_{n+1})^\intercal R^{-1}(\mathbf{y}_{n+1}-C\mathbf{x}_{n+1})\nonumber\\
                 &-\frac{1}{2}(\mathbf{x}_{n+1}-A\mathbf{x}_{n})^\intercal R^{-1}(\mathbf{x}_{n+1}-A\mathbf{x}_{n})\nonumber\\
                 &+\ln P(\mathbf{x}_0,\mathbf{x}_1,\ldots,\mathbf{x}_n,\mathbf{y}_1, \ldots, \mathbf{y}_{n})\label{eq:pn+1}
            \end{align}

            $P_{n+1}$ follows from the observation that the components of
            $\mathbf{x}_n$, $\mathbf{x}_{n+1}$ and $\mathbf{y}_{n+1}$ are combined
            quadratically in the first two lines of Eq.~\ref{eq:pn+1} and, by
            the inductive hypothesis $P_n$, the elements of
            $\mathbf{x}_0,\ldots,\mathbf{x}_n\mathbf{y}_1,\ldots\mathbf{y}_n$
            are combined quadratically in the last line of Eq.~\ref{eq:pn+1}.

    \end{description}

\end{proof}

\section{Kalman Smoother}

The Kalman smoother algorithm addresses the smoothing (Eq.~\ref{eq:smoothing})
inference problem.

\begin{alignat*}{2}
    x_{n|T}&=x_{n|n}+J_n(x_{n+1|T}-x_{n+1|n})\quad&&\text{smoothed mean}\\
    P_{n|T}&=P_{n|n}+J_n(P_{n+1|T}-P_{n+1|n})J_n^\intercal\quad&&\text{smoothed covariance}\\
    J_n&=P_{n|n}A^\intercal P_{n+1|n}^{-1}&&
\end{alignat*}

Inference of smoothed mean and covariances proceeds in a backward fashion:
$x_{T|T}, P_{T|T}\rightarrow x_{T-1|T}, P_{T-1|T}\rightarrow x_{T-2|T},
P_{T-2|T}\rightarrow\ldots\rightarrow  x_{1|T}, P_{1|T}$. The initial mean and
covariances (i.e., $x_{T|T}, P_{T|T}$) are initialized from the last step of
the Kalman filter.

\section{Evaluation}

\subsection{Simulations}

We compare the accuracy of the Kalman filter and smoother with that of the
method of finite differences, to infer velocities and accelerations of a
simulated object following the dynamics of the Discrete Wiener Process
Acceleration (DWPA)
model\footnote{\url{https://github.com/joacorapela/lds_python/blob/master/docs/tracking/tracking.pdf}}.  We used the following parameters in the
simulations:

% \begin{table}[h!]
    % \centering
\begin{center}
    \begin{tabular}{|l|c|}\hline
        \multicolumn{1}{|c|}{\emph{Name}} & \multicolumn{1}{|c|}{\emph{Value}} \\\hline\hline
        $\mathbf{x}_0$                        & $[0, 0]$\\\hline
        $V_0$                                 & diag([0.001, 0.001])\\\hline
        $\gamma=\gamma_1=\gamma_2$            & 1.0\\\hline
        $\sigma=\sigma_1=\sigma_2$            & varied\\\hline
    \end{tabular}
\end{center}
    % \caption{Simulation parameters}
% \end{table}

\noindent We simulated $N=10,000$ samples with a step size $dt=0.001$.

\subsubsection{Lower noise ($\sigma=\num{1e-10}$)}

We simulated measurements from the two-dimensional DWPA model with a standard
deviation for the noise of the observations set to $\sigma=\num{1e-10}$.
Figure~\ref{fig:simulations_low_noise} shows the state positions in blue and
the noise-corrupted measurements in black.

\begin{figure}

    \centering
    \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/28152456_simulation_pos.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/28152456_simulation_pos.png}}

    \caption{Noise corrupted measurements (black) and state positions
    (blue) simulated with low noise (standard deviation $\sigma=\num{1e-10}$)
    using a two-dimensional DWPA model. The noise was so low that the
    differences between measurements and state positions cannot be appreciated
    visually.  The mean-squared error (MSE) between measurements and state
    positions is indcated in the title.
    Click on the image to view its interactive version.}

        \label{fig:simulations_low_noise}

\end{figure}

We next inferred velocities and accelerations from the simulated measurements
(Figure~\ref{fig:vel_acc_low_noise}). For inference we used the Kalman filter,
Kalman smoother and the finite difference method. For these low-noise
simulations, all velocity and acceleration estimates were very accurate.

\begin{figure}

    \begin{subfigure}{\textwidth}
        \centering
        \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/69044958_vel_smoothed.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/69044958_vel_smoothed.png}}
        \caption{Velocity}
    \end{subfigure}

    \begin{subfigure}{\textwidth}
        \centering
        \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/69044958_acc_smoothed.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/69044958_acc_smoothed.png}}
        \caption{Acceleration}
    \end{subfigure}

    \caption{Estimated velocities (a) and accelerations (b) from low-noise
    simulations.  Estimates were obtained using the finite differences method,
    the Kalman filter and the Kalman smoother. Velocity and Acceleration
    estimates using all methods were very accurate.
    Click on the image to view its interactive version.}

    \label{fig:vel_acc_low_noise}

\end{figure}

\subsubsection{Medium noise ($\sigma=\num{1e-3}$)}

We simulated measurements from the two-dimensional DWPA model with a standard
deviation for the noise of the observations set to $\sigma=\num{1e-3}$.
Figure~\ref{fig:simulations_medium_noise} shows the state positions in blue and
the noise-corrupted measurements in black.

\begin{figure}

    \centering
    \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/23897501_simulation_pos.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/23897501_simulation_pos.png}}

    \caption{Noise corrupted measurements (black) and state positions (blue)
    simulated with medium noise (standard deviation $\sigma=\num{1e-3}$) using
    a two-dimensional DWPA model.  The noise was still so low that the
    differences between measurements and state positions cannot be appreciated
    visually.  The MSE between measurements and state positions is indicated in
    the title. Click on the image to view its interactive version.}

    \label{fig:simulations_medium_noise}

\end{figure}

We next inferred velocities and accelerations from the simulated measurements
(Figure~\ref{fig:vel_acc_medium_noise}). For these medium-noise simulations,
all velocity estimates were accurate. The Kalman filter and smoother estimates
of acceleration were also accurate, but the finite difference estimates of
acceleration were not.

\begin{figure}

    \begin{subfigure}{\textwidth}
        \centering
        \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/01448032_vel_smoothed.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/01448032_vel_smoothed.png}}
        \caption{Velocity}
    \end{subfigure}

    \begin{subfigure}{\textwidth}
        \centering
        \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/01448032_acc_smoothed.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/01448032_acc_smoothed.png}}
        \caption{Acceleration}
    \end{subfigure}

    \caption{Estimated velocities (a) and accelerations (b) from medium-noise
    simulations. Estimates were obtained using the finite differences method,
    the Kalman filter and Kalman smoother.  Estimates of velocity by all
    methods were accurate. Estimates of accelerations by the Kalman filter and
    smoother were also accurate, but not those by the finite difference method.
    Click on the image to view its interactive version.}

    \label{fig:vel_acc_medium_noise}

\end{figure}

\subsubsection{Higher noise ($\sigma=\num{1e-1}$)}

We simulated measurements from the two-dimensional DWPA model with a standard
deviation for the noise of the observations set to $\sigma=\num{1e-1}$.
Figure~\ref{fig:simulations_high_noise} shows the state positions in blue and
the noise-corrupted measurements in black.

\begin{figure}

    \centering
    \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/01112777_simulation_pos.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/01112777_simulation_pos.png}}

    \caption{Noise corrupted measurements (black) and state positions (blue)
    simulated with high noise (standard deviation $\sigma=\num{1e-1}$) using a
    two-dimensional DWPA model. The noise can now be appreciated visually.  The
    MSE between measurements and state positions is indicated in the title.
    Click on the image to view its interactive version.}

    \label{fig:simulations_high_noise}

\end{figure}

We next inferred velocities and accelerations from the simulated measurements
(Figure~\ref{fig:vel_acc_high_noise}).  For these high-noise simulations,
velocity and acceleration estimates by the Kalman filter and smoother were
accurate, but those from the finite difference method were not.

\begin{figure}

    \begin{subfigure}{\textwidth}
        \centering
        \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/58788639_vel_smoothed.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/58788639_vel_smoothed.png}}
        \caption{Velocity}
    \end{subfigure}

    \begin{subfigure}{\textwidth}
        \centering
        \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/58788639_acc_smoothed.html}{\includegraphics[width=5in]{../../../projects/lds_simulations/figures/58788639_acc_smoothed.png}}
        \caption{Acceleration}
    \end{subfigure}

    \caption{Estimated velocities (a) and accelerations (b) from high-noise
    simulations.  Estimates were obtained using the finite differences method,
    the Kalman filter and the Kalman smoother. Velocity and Acceleration
    estimates by the Kalman filter and smoother were accurate, but not those by
    the finite differences methods. Click on the image to view its interactive
    version.}

    \label{fig:vel_acc_high_noise}

\end{figure}

\subsubsection{Conclusions}

It is remarkable that the finite difference method breaks down when adding very
little noise to the true measurements. As we increased the amount of noise,
this break down happened earlier for accelerations than for velocities.
%
The Kalman filter and smoother were robust to the amount of noise considered
here, both for the estimation of velocities and accelerations.

\subsection{Foraging mouse}

Figure~\ref{fig:foraging} shows the measured and Kalman filtered and smoothed
positions of a mouse foraging in a circular arena.

\begin{figure}
    \begin{center}

        \begin{subfigure}{\textwidth}
            \centering
            \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/positions_smoothed_session003_start0.00_end15548.27_startPosition0_numPosition10000_pos.html}{\includegraphics[width=3in]{../../../projects/lds_simulations/figures/positions_smoothed_session003_start0.00_end15548.27_startPosition0_numPosition10000_pos.png}}
            \caption{Positions}
        \end{subfigure}

        \begin{subfigure}{\textwidth}
            \centering
            \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/positions_smoothed_session003_start0.00_end15548.27_startPosition0_numPosition10000_vel.html}{\includegraphics[width=3in]{../../../projects/lds_simulations/figures/positions_smoothed_session003_start0.00_end15548.27_startPosition0_numPosition10000_vel.png}}
            \caption{Velocities}
        \end{subfigure}

        \begin{subfigure}{\textwidth}
            \centering
            \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/positions_smoothed_session003_start0.00_end15548.27_startPosition0_numPosition10000_acc.html}{\includegraphics[width=3in]{../../../projects/lds_simulations/figures/positions_smoothed_session003_start0.00_end15548.27_startPosition0_numPosition10000_acc.png}}
            \caption{Accelerations}
        \end{subfigure}


        \caption{Kalman filtered and smoothed positions, velocities and
        accelerations of a mouse foraging in a circular arena. Click on the
        images to see their interactive versions.}

        \label{fig:foraging}

    \end{center}
\end{figure}

\subsection{Mouse running on a maze}

Figure~\ref{fig:runningMaze} shows the measured and Kalman filtered and smoothed
positions of a mouse running in a maze.

\begin{figure}
    \begin{center}

        \begin{subfigure}{\textwidth}
            \centering
            \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/smoothed_results_fede_firstSample0_numberOfSamples10000_pos.html}{\includegraphics[width=3in]{../../../projects/lds_simulations/figures/smoothed_results_fede_firstSample0_numberOfSamples10000_pos.png}}
            \caption{Positions}
        \end{subfigure}

        \begin{subfigure}{\textwidth}
            \centering
            \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/smoothed_results_fede_firstSample0_numberOfSamples10000_vel.html}{\includegraphics[width=3in]{../../../projects/lds_simulations/figures/smoothed_results_fede_firstSample0_numberOfSamples10000_vel.png}}
            \caption{Velocities}
        \end{subfigure}

        \begin{subfigure}{\textwidth}
            \centering
            \href{http://www.gatsby.ucl.ac.uk/~rapela/fwg/lds_repo/inference/figures/smoothed_results_fede_firstSample0_numberOfSamples10000_acc.html}{\includegraphics[width=3in]{../../../projects/lds_simulations/figures/smoothed_results_fede_firstSample0_numberOfSamples10000_acc.png}}
            \caption{Accelerations}
        \end{subfigure}


        \caption{Kalman filtered and smoothed positions, velocities and
        accelerations of a mouse running in a maze. Click on the images to see
        their interactive versions.}

        \label{fig:runningMaze}

    \end{center}
\end{figure}

\bibliographystyle{apalike}
\bibliography{machineLearning,linearDynamicalSystems}

\end{document}
